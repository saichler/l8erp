<!--
Â© 2025 Sharon Aicler (saichler@gmail.com)

Layer 8 Ecosystem is licensed under the Apache License, Version 2.0.
You may obtain a copy of the License at:

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->
<div class="section-container" id="logistics-section">
    <div class="page-header">
        <div>
            <h1 class="page-title">Logistics</h1>
            <p class="page-subtitle">Carriers, freight rates, shipments, routes, and delivery management</p>
        </div>
    </div>

    <!-- Service Tabs -->
    <div class="section-tabs">
        <button class="section-tab active" data-service="carriers">Carriers</button>
        <button class="section-tab" data-service="freight-rates">Rates</button>
        <button class="section-tab" data-service="shipments">Shipments</button>
        <button class="section-tab" data-service="routes">Routes</button>
        <button class="section-tab" data-service="load-plans">Load Plans</button>
        <button class="section-tab" data-service="delivery-proofs">Delivery</button>
        <button class="section-tab" data-service="freight-audits">Audits</button>
        <button class="section-tab" data-service="return-authorizations">Returns</button>
    </div>

    <!-- Table Container -->
    <div id="logistics-table"></div>
</div>

<script>
let logisticsTable = null;
let currentLogisticsService = 'carriers';

const LOGISTICS_SERVICES = {
    'carriers': {
        endpoint: Layer8MConfig.resolveEndpoint('/50/ScmCarrier'),
        modelName: 'ScmCarrier',
        idField: 'carrierId',
        columns: [
            { key: 'carrierId', label: 'ID', primary: true },
            { key: 'code', label: 'Code', secondary: true, filterKey: 'code' },
            { key: 'name', label: 'Name' },
            { key: 'carrierType', label: 'Type', formatter: (v) => ({ 0: 'Unspecified', 1: 'Trucking', 2: 'Rail', 3: 'Ocean', 4: 'Air', 5: 'Courier', 6: 'Intermodal' }[v] || '-') },
            { key: 'contactInfo', label: 'Contact' }
        ],
        addText: 'Add Carrier',
        formFields: [
            { key: 'code', label: 'Carrier Code', type: 'text', required: true },
            { key: 'name', label: 'Name', type: 'text', required: true },
            { key: 'carrierType', label: 'Carrier Type', type: 'select', options: { 0: 'Unspecified', 1: 'Trucking', 2: 'Rail', 3: 'Ocean', 4: 'Air', 5: 'Courier', 6: 'Intermodal' } },
            { key: 'contactInfo', label: 'Contact Info', type: 'text' },
            { key: 'website', label: 'Website', type: 'text' },
            { key: 'isActive', label: 'Active', type: 'checkbox' }
        ]
    },
    'freight-rates': {
        endpoint: Layer8MConfig.resolveEndpoint('/50/FreightRt'),
        modelName: 'ScmFreightRate',
        idField: 'rateId',
        columns: [
            { key: 'rateId', label: 'ID', primary: true },
            { key: 'carrierId', label: 'Carrier', secondary: true },
            { key: 'origin', label: 'Origin' },
            { key: 'destination', label: 'Destination' },
            { key: 'ratePerUnit', label: 'Rate/Unit', formatter: (v) => Layer8MUtils.formatMoney(v) },
            { key: 'effectiveDate', label: 'Effective', formatter: (v) => Layer8MUtils.formatDate(v) }
        ],
        addText: 'Add Freight Rate',
        formFields: [
            { key: 'carrierId', label: 'Carrier', type: 'reference', lookupModel: 'ScmCarrier', required: true },
            { key: 'origin', label: 'Origin', type: 'text', required: true },
            { key: 'destination', label: 'Destination', type: 'text', required: true },
            { key: 'ratePerUnit', label: 'Rate per Unit', type: 'currency', required: true },
            { key: 'unitOfMeasure', label: 'Unit of Measure', type: 'text' },
            { key: 'effectiveDate', label: 'Effective Date', type: 'date', required: true },
            { key: 'expirationDate', label: 'Expiration Date', type: 'date' }
        ]
    },
    'shipments': {
        endpoint: Layer8MConfig.resolveEndpoint('/50/Shipment'),
        modelName: 'ScmShipment',
        idField: 'shipmentId',
        columns: [
            { key: 'shipmentId', label: 'ID', primary: true },
            { key: 'shipmentNumber', label: 'Shipment #', secondary: true, filterKey: 'shipmentNumber' },
            { key: 'carrierId', label: 'Carrier' },
            { key: 'shipDate', label: 'Ship Date', formatter: (v) => Layer8MUtils.formatDate(v) },
            { key: 'status', label: 'Status', formatter: (v) => ({ 0: 'Unspecified', 1: 'Planned', 2: 'Picked Up', 3: 'In Transit', 4: 'Delivered', 5: 'Returned', 6: 'Cancelled' }[v] || '-') },
            { key: 'freightCost', label: 'Cost', formatter: (v) => Layer8MUtils.formatMoney(v) }
        ],
        addText: 'Add Shipment',
        formFields: [
            { key: 'shipmentNumber', label: 'Shipment Number', type: 'text', required: true },
            { key: 'carrierId', label: 'Carrier', type: 'reference', lookupModel: 'ScmCarrier', required: true },
            { key: 'origin', label: 'Origin', type: 'text' },
            { key: 'destination', label: 'Destination', type: 'text' },
            { key: 'shipDate', label: 'Ship Date', type: 'date', required: true },
            { key: 'expectedDelivery', label: 'Expected Delivery', type: 'date' },
            { key: 'status', label: 'Status', type: 'select', options: { 0: 'Unspecified', 1: 'Planned', 2: 'Picked Up', 3: 'In Transit', 4: 'Delivered', 5: 'Returned', 6: 'Cancelled' } },
            { key: 'freightCost', label: 'Freight Cost', type: 'currency' }
        ]
    },
    'routes': {
        endpoint: Layer8MConfig.resolveEndpoint('/50/Route'),
        modelName: 'ScmRoute',
        idField: 'routeId',
        columns: [
            { key: 'routeId', label: 'ID', primary: true },
            { key: 'name', label: 'Route', secondary: true, filterKey: 'name' },
            { key: 'origin', label: 'Origin' },
            { key: 'destination', label: 'Destination' },
            { key: 'distance', label: 'Distance' },
            { key: 'estimatedTime', label: 'Est. Time' }
        ],
        addText: 'Add Route',
        formFields: [
            { key: 'name', label: 'Route Name', type: 'text', required: true },
            { key: 'origin', label: 'Origin', type: 'text', required: true },
            { key: 'destination', label: 'Destination', type: 'text', required: true },
            { key: 'distance', label: 'Distance', type: 'number' },
            { key: 'estimatedTime', label: 'Estimated Time', type: 'text' },
            { key: 'description', label: 'Description', type: 'textarea' }
        ]
    },
    'load-plans': {
        endpoint: Layer8MConfig.resolveEndpoint('/50/LoadPlan'),
        modelName: 'ScmLoadPlan',
        idField: 'loadPlanId',
        columns: [
            { key: 'loadPlanId', label: 'ID', primary: true },
            { key: 'plannedDate', label: 'Planned', secondary: true, formatter: (v) => Layer8MUtils.formatDate(v) },
            { key: 'shipmentId', label: 'Shipment' },
            { key: 'vehicleId', label: 'Vehicle' },
            { key: 'totalWeight', label: 'Weight' },
            { key: 'status', label: 'Status', formatter: (v) => ({ 0: 'Unspecified', 1: 'Pending', 2: 'In Progress', 3: 'Completed', 4: 'Cancelled' }[v] || '-') }
        ],
        addText: 'Add Load Plan',
        formFields: [
            { key: 'plannedDate', label: 'Planned Date', type: 'date' },
            { key: 'shipmentId', label: 'Shipment', type: 'reference', lookupModel: 'ScmShipment', required: true },
            { key: 'vehicleId', label: 'Vehicle', type: 'text' },
            { key: 'totalWeight', label: 'Total Weight', type: 'number' },
            { key: 'totalVolume', label: 'Total Volume', type: 'number' },
            { key: 'status', label: 'Status', type: 'select', options: { 0: 'Unspecified', 1: 'Pending', 2: 'In Progress', 3: 'Completed', 4: 'Cancelled' } },
            { key: 'notes', label: 'Notes', type: 'textarea' }
        ]
    },
    'delivery-proofs': {
        endpoint: Layer8MConfig.resolveEndpoint('/50/DlvryProof'),
        modelName: 'ScmDeliveryProof',
        idField: 'proofId',
        columns: [
            { key: 'proofId', label: 'ID', primary: true },
            { key: 'shipmentId', label: 'Shipment', secondary: true },
            { key: 'deliveryDate', label: 'Delivered', formatter: (v) => Layer8MUtils.formatDate(v) },
            { key: 'receivedBy', label: 'Received By' }
        ],
        addText: 'Add Delivery Proof',
        formFields: [
            { key: 'shipmentId', label: 'Shipment', type: 'reference', lookupModel: 'ScmShipment', required: true },
            { key: 'deliveryDate', label: 'Delivery Date', type: 'date', required: true },
            { key: 'receivedBy', label: 'Received By', type: 'text', required: true },
            { key: 'signatureRef', label: 'Signature Reference', type: 'text' },
            { key: 'status', label: 'Status', type: 'select', options: { 0: 'Unspecified', 1: 'Pending', 2: 'In Progress', 3: 'Completed', 4: 'Cancelled' } },
            { key: 'notes', label: 'Notes', type: 'textarea' }
        ]
    },
    'freight-audits': {
        endpoint: Layer8MConfig.resolveEndpoint('/50/FrtAudit'),
        modelName: 'ScmFreightAudit',
        idField: 'auditId',
        columns: [
            { key: 'auditId', label: 'ID', primary: true },
            { key: 'shipmentId', label: 'Shipment', secondary: true },
            { key: 'carrierId', label: 'Carrier' },
            { key: 'invoicedAmount', label: 'Invoiced', formatter: (v) => Layer8MUtils.formatMoney(v) },
            { key: 'actualAmount', label: 'Actual', formatter: (v) => Layer8MUtils.formatMoney(v) },
            { key: 'variance', label: 'Variance', formatter: (v) => Layer8MUtils.formatMoney(v) }
        ],
        addText: 'Add Freight Audit',
        formFields: [
            { key: 'shipmentId', label: 'Shipment', type: 'reference', lookupModel: 'ScmShipment', required: true },
            { key: 'carrierId', label: 'Carrier', type: 'reference', lookupModel: 'ScmCarrier', required: true },
            { key: 'invoicedAmount', label: 'Invoiced Amount', type: 'currency', required: true },
            { key: 'actualAmount', label: 'Actual Amount', type: 'currency' },
            { key: 'variance', label: 'Variance', type: 'currency' },
            { key: 'notes', label: 'Notes', type: 'textarea' }
        ]
    },
    'return-authorizations': {
        endpoint: Layer8MConfig.resolveEndpoint('/50/ReturnAuth'),
        modelName: 'ScmReturnAuthorization',
        idField: 'rmaId',
        columns: [
            { key: 'rmaId', label: 'ID', primary: true },
            { key: 'rmaNumber', label: 'RMA #', secondary: true, filterKey: 'rmaNumber' },
            { key: 'customerId', label: 'Customer' },
            { key: 'returnDate', label: 'Return Date', formatter: (v) => Layer8MUtils.formatDate(v) },
            { key: 'reason', label: 'Reason' },
            { key: 'status', label: 'Status', formatter: (v) => ({ 0: 'Unspecified', 1: 'Pending', 2: 'In Progress', 3: 'Completed', 4: 'Cancelled' }[v] || '-') }
        ],
        addText: 'Add Return Authorization',
        formFields: [
            { key: 'rmaNumber', label: 'RMA Number', type: 'text', required: true },
            { key: 'customerId', label: 'Customer', type: 'reference', lookupModel: 'Customer' },
            { key: 'returnDate', label: 'Return Date', type: 'date', required: true },
            { key: 'reason', label: 'Reason', type: 'textarea', required: true },
            { key: 'status', label: 'Status', type: 'select', options: { 0: 'Unspecified', 1: 'Pending', 2: 'In Progress', 3: 'Completed', 4: 'Cancelled' } },
            { key: 'notes', label: 'Notes', type: 'textarea' }
        ]
    }
};

function initMobileLogistics() {
    loadLogisticsService('carriers');

    document.querySelectorAll('.section-tab').forEach(tab => {
        tab.addEventListener('click', () => {
            document.querySelectorAll('.section-tab').forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            loadLogisticsService(tab.dataset.service);
        });
    });
}

function loadLogisticsService(serviceName) {
    currentLogisticsService = serviceName;
    const config = LOGISTICS_SERVICES[serviceName];

    logisticsTable = new Layer8MEditTable('logistics-table', {
        endpoint: config.endpoint,
        modelName: config.modelName,
        columns: config.columns,
        rowsPerPage: 15,
        addButtonText: config.addText,
        onAdd: () => openLogisticsForm(config),
        onEdit: (id, item) => openLogisticsForm(config, item),
        onDelete: (id, item) => deleteLogisticsItem(config, id, item),
        getItemId: (item) => item[config.idField]
    });
}

function openLogisticsForm(config, item = null) {
    const isEdit = !!item;
    const title = isEdit ? 'Edit' : config.addText;

    const formDef = { fields: config.formFields };
    const content = Layer8MForms.renderForm(formDef, item || {});

    Layer8MPopup.show({
        title: title,
        content: content,
        size: 'medium',
        saveButtonText: isEdit ? 'Update' : 'Create',
        onSave: async (popup) => {
            const body = popup.body;
            const errors = Layer8MForms.validateForm(body);
            if (errors.length > 0) { Layer8MForms.showErrors(body, errors); return; }

            const data = Layer8MForms.getFormData(body);
            if (isEdit) data[config.idField] = item[config.idField];

            try {
                if (isEdit) await Layer8MAuth.put(config.endpoint, data);
                else await Layer8MAuth.post(config.endpoint, data);
                Layer8MUtils.showSuccess(isEdit ? 'Updated' : 'Created');
                Layer8MPopup.close();
                logisticsTable.refresh();
            } catch (error) {
                Layer8MUtils.showError('Failed to save');
            }
        }
    });
}

async function deleteLogisticsItem(config, id, item) {
    const name = item.code || item.shipmentNumber || item.name || item.rmaNumber || id;
    const confirmed = await Layer8MConfirm.confirmDelete(name);
    if (confirmed) {
        try {
            await Layer8MAuth.delete(config.endpoint + '?id=' + id);
            Layer8MUtils.showSuccess('Deleted');
            logisticsTable.refresh();
        } catch (error) {
            Layer8MUtils.showError('Failed to delete');
        }
    }
}
</script>
