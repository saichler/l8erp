<!--
Â© 2025 Sharon Aicler (saichler@gmail.com)

Layer 8 Ecosystem is licensed under the Apache License, Version 2.0.
You may obtain a copy of the License at:

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->
<div class="section-container" id="warehouse-section">
    <div class="page-header">
        <div>
            <h1 class="page-title">Warehouse</h1>
            <p class="page-subtitle">Warehouses, bins, receiving, putaway, picking, packing, and shipping</p>
        </div>
    </div>

    <!-- Service Tabs -->
    <div class="section-tabs">
        <button class="section-tab active" data-service="warehouses">Warehouses</button>
        <button class="section-tab" data-service="bins">Bins</button>
        <button class="section-tab" data-service="receiving-orders">Receiving</button>
        <button class="section-tab" data-service="putaway-tasks">Putaway</button>
        <button class="section-tab" data-service="pick-tasks">Pick</button>
        <button class="section-tab" data-service="pack-tasks">Pack</button>
        <button class="section-tab" data-service="ship-tasks">Ship</button>
        <button class="section-tab" data-service="wave-plans">Waves</button>
        <button class="section-tab" data-service="dock-schedules">Docks</button>
    </div>

    <!-- Table Container -->
    <div id="warehouse-table"></div>
</div>

<script>
let warehouseTable = null;
let currentWarehouseService = 'warehouses';

const WAREHOUSE_SERVICES = {
    'warehouses': {
        endpoint: Layer8MConfig.resolveEndpoint('/50/Warehouse'),
        modelName: 'ScmWarehouse',
        idField: 'warehouseId',
        columns: [
            { key: 'warehouseId', label: 'ID', primary: true },
            { key: 'code', label: 'Code', secondary: true, filterKey: 'code' },
            { key: 'name', label: 'Name' },
            { key: 'warehouseType', label: 'Type', formatter: (v) => ({ 0: 'Unspecified', 1: 'Distribution Center', 2: 'Manufacturing', 3: 'Cold Storage', 4: 'Cross-Dock', 5: 'Bonded' }[v] || '-') },
            { key: 'address', label: 'Location', formatter: (v) => v?.city || '' }
        ],
        addText: 'Add Warehouse',
        formFields: [
            { key: 'code', label: 'Warehouse Code', type: 'text', required: true },
            { key: 'name', label: 'Name', type: 'text', required: true },
            { key: 'warehouseType', label: 'Type', type: 'select', options: { 0: 'Unspecified', 1: 'Distribution Center', 2: 'Manufacturing', 3: 'Cold Storage', 4: 'Cross-Dock', 5: 'Bonded' } },
            { key: 'address', label: 'Address', type: 'textarea' },
            { key: 'managerId', label: 'Manager', type: 'reference', lookupModel: 'Employee' },
            { key: 'isActive', label: 'Active', type: 'checkbox' }
        ]
    },
    'bins': {
        endpoint: Layer8MConfig.resolveEndpoint('/50/Bin'),
        modelName: 'ScmBin',
        idField: 'binId',
        columns: [
            { key: 'binId', label: 'ID', primary: true },
            { key: 'binCode', label: 'Bin Code', secondary: true, filterKey: 'binCode' },
            { key: 'warehouseId', label: 'Warehouse' },
            { key: 'binType', label: 'Type', formatter: (v) => ({ 0: 'Unspecified', 1: 'Storage', 2: 'Picking', 3: 'Receiving', 4: 'Shipping', 5: 'Staging' }[v] || '-') },
            { key: 'zone', label: 'Zone' }
        ],
        addText: 'Add Bin',
        formFields: [
            { key: 'binCode', label: 'Bin Code', type: 'text', required: true },
            { key: 'warehouseId', label: 'Warehouse', type: 'reference', lookupModel: 'ScmWarehouse', required: true },
            { key: 'binType', label: 'Bin Type', type: 'select', options: { 0: 'Unspecified', 1: 'Storage', 2: 'Picking', 3: 'Receiving', 4: 'Shipping', 5: 'Staging' } },
            { key: 'zone', label: 'Zone', type: 'text' },
            { key: 'aisle', label: 'Aisle', type: 'text' },
            { key: 'rack', label: 'Rack', type: 'text' },
            { key: 'level', label: 'Level', type: 'text' },
            { key: 'isActive', label: 'Active', type: 'checkbox' }
        ]
    },
    'receiving-orders': {
        endpoint: Layer8MConfig.resolveEndpoint('/50/RecvOrder'),
        modelName: 'ScmReceivingOrder',
        idField: 'receivingOrderId',
        columns: [
            { key: 'receivingOrderId', label: 'ID', primary: true },
            { key: 'purchaseOrderId', label: 'PO', secondary: true, filterKey: 'purchaseOrderId' },
            { key: 'receivedBy', label: 'Received By' },
            { key: 'receivingDate', label: 'Receiving', formatter: (v) => Layer8MUtils.formatDate(v) },
            { key: 'status', label: 'Status', formatter: (v) => ({ 0: 'Unspecified', 1: 'Pending', 2: 'In Progress', 3: 'Completed', 4: 'Cancelled' }[v] || '-') },
            { key: 'warehouseId', label: 'Warehouse' }
        ],
        addText: 'Add Receiving Order',
        formFields: [
            { key: 'purchaseOrderId', label: 'Purchase Order', type: 'reference', lookupModel: 'ScmPurchaseOrder', required: true },
            { key: 'receivedBy', label: 'Received By', type: 'text' },
            { key: 'receivingDate', label: 'Receiving Date', type: 'date', required: true },
            { key: 'warehouseId', label: 'Warehouse', type: 'reference', lookupModel: 'ScmWarehouse', required: true },
            { key: 'status', label: 'Status', type: 'select', options: { 0: 'Unspecified', 1: 'Pending', 2: 'In Progress', 3: 'Completed', 4: 'Cancelled' } },
            { key: 'notes', label: 'Notes', type: 'textarea' }
        ]
    },
    'putaway-tasks': {
        endpoint: Layer8MConfig.resolveEndpoint('/50/PutAway'),
        modelName: 'ScmPutawayTask',
        idField: 'taskId',
        columns: [
            { key: 'taskId', label: 'ID', primary: true },
            { key: 'receivingOrderId', label: 'Receiving Order', secondary: true },
            { key: 'itemId', label: 'Item' },
            { key: 'fromBinId', label: 'From Bin' },
            { key: 'toBinId', label: 'To Bin' },
            { key: 'status', label: 'Status', formatter: (v) => ({ 0: 'Unspecified', 1: 'Pending', 2: 'In Progress', 3: 'Completed', 4: 'Cancelled' }[v] || '-') }
        ],
        addText: 'Add Putaway Task',
        formFields: [
            { key: 'receivingOrderId', label: 'Receiving Order', type: 'reference', lookupModel: 'ScmReceivingOrder', required: true },
            { key: 'itemId', label: 'Item', type: 'reference', lookupModel: 'ScmItem', required: true },
            { key: 'quantity', label: 'Quantity', type: 'number', required: true },
            { key: 'fromBinId', label: 'From Bin', type: 'reference', lookupModel: 'ScmBin' },
            { key: 'toBinId', label: 'To Bin', type: 'reference', lookupModel: 'ScmBin', required: true },
            { key: 'status', label: 'Status', type: 'select', options: { 0: 'Unspecified', 1: 'Pending', 2: 'In Progress', 3: 'Completed', 4: 'Cancelled' } },
            { key: 'assignedTo', label: 'Assigned To', type: 'reference', lookupModel: 'Employee' }
        ]
    },
    'pick-tasks': {
        endpoint: Layer8MConfig.resolveEndpoint('/50/PickTask'),
        modelName: 'ScmPickTask',
        idField: 'taskId',
        columns: [
            { key: 'taskId', label: 'ID', primary: true },
            { key: 'wavePlanId', label: 'Wave Plan', secondary: true, filterKey: 'wavePlanId' },
            { key: 'itemId', label: 'Item' },
            { key: 'fromBinId', label: 'Bin' },
            { key: 'quantity', label: 'Qty' },
            { key: 'status', label: 'Status', formatter: (v) => ({ 0: 'Unspecified', 1: 'Pending', 2: 'In Progress', 3: 'Completed', 4: 'Cancelled' }[v] || '-') }
        ],
        addText: 'Add Pick Task',
        formFields: [
            { key: 'wavePlanId', label: 'Wave Plan', type: 'reference', lookupModel: 'ScmWavePlan', required: true },
            { key: 'itemId', label: 'Item', type: 'reference', lookupModel: 'ScmItem', required: true },
            { key: 'fromBinId', label: 'Bin', type: 'reference', lookupModel: 'ScmBin', required: true },
            { key: 'quantity', label: 'Quantity', type: 'number', required: true },
            { key: 'status', label: 'Status', type: 'select', options: { 0: 'Unspecified', 1: 'Pending', 2: 'In Progress', 3: 'Completed', 4: 'Cancelled' } },
            { key: 'assignedTo', label: 'Assigned To', type: 'reference', lookupModel: 'Employee' }
        ]
    },
    'pack-tasks': {
        endpoint: Layer8MConfig.resolveEndpoint('/50/PackTask'),
        modelName: 'ScmPackTask',
        idField: 'taskId',
        columns: [
            { key: 'taskId', label: 'ID', primary: true },
            { key: 'pickTaskId', label: 'Pick Task', secondary: true, filterKey: 'pickTaskId' },
            { key: 'packageId', label: 'Package' },
            { key: 'quantity', label: 'Qty' },
            { key: 'status', label: 'Status', formatter: (v) => ({ 0: 'Unspecified', 1: 'Pending', 2: 'In Progress', 3: 'Completed', 4: 'Cancelled' }[v] || '-') }
        ],
        addText: 'Add Pack Task',
        formFields: [
            { key: 'pickTaskId', label: 'Pick Task', type: 'reference', lookupModel: 'ScmPickTask', required: true },
            { key: 'packageId', label: 'Package', type: 'text' },
            { key: 'quantity', label: 'Quantity', type: 'number' },
            { key: 'status', label: 'Status', type: 'select', options: { 0: 'Unspecified', 1: 'Pending', 2: 'In Progress', 3: 'Completed', 4: 'Cancelled' } },
            { key: 'assignedTo', label: 'Assigned To', type: 'reference', lookupModel: 'Employee' },
            { key: 'notes', label: 'Notes', type: 'textarea' }
        ]
    },
    'ship-tasks': {
        endpoint: Layer8MConfig.resolveEndpoint('/50/ShipTask'),
        modelName: 'ScmShipTask',
        idField: 'taskId',
        columns: [
            { key: 'taskId', label: 'ID', primary: true },
            { key: 'shipmentId', label: 'Shipment', secondary: true },
            { key: 'carrierId', label: 'Carrier' },
            { key: 'trackingNumber', label: 'Tracking #' },
            { key: 'shippedAt', label: 'Shipped', formatter: (v) => Layer8MUtils.formatDate(v) },
            { key: 'status', label: 'Status', formatter: (v) => ({ 0: 'Unspecified', 1: 'Pending', 2: 'In Progress', 3: 'Completed', 4: 'Cancelled' }[v] || '-') }
        ],
        addText: 'Add Ship Task',
        formFields: [
            { key: 'shipmentId', label: 'Shipment', type: 'reference', lookupModel: 'ScmShipment', required: true },
            { key: 'carrierId', label: 'Carrier', type: 'reference', lookupModel: 'ScmCarrier' },
            { key: 'trackingNumber', label: 'Tracking Number', type: 'text' },
            { key: 'shippedAt', label: 'Shipped At', type: 'date' },
            { key: 'status', label: 'Status', type: 'select', options: { 0: 'Unspecified', 1: 'Pending', 2: 'In Progress', 3: 'Completed', 4: 'Cancelled' } }
        ]
    },
    'wave-plans': {
        endpoint: Layer8MConfig.resolveEndpoint('/50/WavePlan'),
        modelName: 'ScmWavePlan',
        idField: 'wavePlanId',
        columns: [
            { key: 'wavePlanId', label: 'ID', primary: true },
            { key: 'assignedTo', label: 'Assigned To', secondary: true, filterKey: 'assignedTo' },
            { key: 'warehouseId', label: 'Warehouse' },
            { key: 'planDate', label: 'Plan Date', formatter: (v) => Layer8MUtils.formatDate(v) },
            { key: 'totalOrders', label: 'Orders' },
            { key: 'status', label: 'Status', formatter: (v) => ({ 0: 'Unspecified', 1: 'Pending', 2: 'In Progress', 3: 'Completed', 4: 'Cancelled' }[v] || '-') }
        ],
        addText: 'Add Wave Plan',
        formFields: [
            { key: 'assignedTo', label: 'Assigned To', type: 'reference', lookupModel: 'Employee' },
            { key: 'warehouseId', label: 'Warehouse', type: 'reference', lookupModel: 'ScmWarehouse', required: true },
            { key: 'planDate', label: 'Plan Date', type: 'date', required: true },
            { key: 'totalOrders', label: 'Total Orders', type: 'number' },
            { key: 'status', label: 'Status', type: 'select', options: { 0: 'Unspecified', 1: 'Pending', 2: 'In Progress', 3: 'Completed', 4: 'Cancelled' } },
            { key: 'notes', label: 'Notes', type: 'textarea' }
        ]
    },
    'dock-schedules': {
        endpoint: Layer8MConfig.resolveEndpoint('/50/DockSched'),
        modelName: 'ScmDockSchedule',
        idField: 'scheduleId',
        columns: [
            { key: 'scheduleId', label: 'ID', primary: true },
            { key: 'dockNumber', label: 'Dock', secondary: true },
            { key: 'carrierId', label: 'Carrier' },
            { key: 'scheduleDate', label: 'Date', formatter: (v) => Layer8MUtils.formatDate(v) },
            { key: 'direction', label: 'Direction' },
            { key: 'status', label: 'Status', formatter: (v) => ({ 0: 'Unspecified', 1: 'Pending', 2: 'In Progress', 3: 'Completed', 4: 'Cancelled' }[v] || '-') }
        ],
        addText: 'Add Dock Schedule',
        formFields: [
            { key: 'dockNumber', label: 'Dock Number', type: 'text', required: true },
            { key: 'carrierId', label: 'Carrier', type: 'reference', lookupModel: 'ScmCarrier' },
            { key: 'scheduleDate', label: 'Schedule Date', type: 'date', required: true },
            { key: 'direction', label: 'Direction', type: 'text' },
            { key: 'status', label: 'Status', type: 'select', options: { 0: 'Unspecified', 1: 'Pending', 2: 'In Progress', 3: 'Completed', 4: 'Cancelled' } },
            { key: 'notes', label: 'Notes', type: 'textarea' }
        ]
    }
};

function initMobileWarehouse() {
    loadWarehouseService('warehouses');

    document.querySelectorAll('.section-tab').forEach(tab => {
        tab.addEventListener('click', () => {
            document.querySelectorAll('.section-tab').forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            loadWarehouseService(tab.dataset.service);
        });
    });
}

function loadWarehouseService(serviceName) {
    currentWarehouseService = serviceName;
    const config = WAREHOUSE_SERVICES[serviceName];

    warehouseTable = new Layer8MEditTable('warehouse-table', {
        endpoint: config.endpoint,
        modelName: config.modelName,
        columns: config.columns,
        rowsPerPage: 15,
        addButtonText: config.addText,
        onAdd: () => openWarehouseForm(config),
        onEdit: (id, item) => openWarehouseForm(config, item),
        onDelete: (id, item) => deleteWarehouseItem(config, id, item),
        getItemId: (item) => item[config.idField]
    });
}

function openWarehouseForm(config, item = null) {
    const isEdit = !!item;
    const title = isEdit ? 'Edit' : config.addText;

    const formDef = { fields: config.formFields };
    const content = Layer8MForms.renderForm(formDef, item || {});

    Layer8MPopup.show({
        title: title,
        content: content,
        size: 'medium',
        saveButtonText: isEdit ? 'Update' : 'Create',
        onSave: async (popup) => {
            const body = popup.body;
            const errors = Layer8MForms.validateForm(body);
            if (errors.length > 0) { Layer8MForms.showErrors(body, errors); return; }

            const data = Layer8MForms.getFormData(body);
            if (isEdit) data[config.idField] = item[config.idField];

            try {
                if (isEdit) await Layer8MAuth.put(config.endpoint, data);
                else await Layer8MAuth.post(config.endpoint, data);
                Layer8MUtils.showSuccess(isEdit ? 'Updated' : 'Created');
                Layer8MPopup.close();
                warehouseTable.refresh();
            } catch (error) {
                Layer8MUtils.showError('Failed to save');
            }
        }
    });
}

async function deleteWarehouseItem(config, id, item) {
    const name = item.code || item.binCode || item.purchaseOrderId || item.assignedTo || id;
    const confirmed = await Layer8MConfirm.confirmDelete(name);
    if (confirmed) {
        try {
            await Layer8MAuth.delete(config.endpoint + '?id=' + id);
            Layer8MUtils.showSuccess('Deleted');
            warehouseTable.refresh();
        } catch (error) {
            Layer8MUtils.showError('Failed to delete');
        }
    }
}
</script>
