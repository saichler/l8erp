<!--
Â© 2025 Sharon Aicler (saichler@gmail.com)

Layer 8 Ecosystem is licensed under the Apache License, Version 2.0.
You may obtain a copy of the License at:

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->
<div class="section-container" id="dashboard-section">
    <!-- Dashboard Stats -->
    <div id="nav-stats" class="nav-stats-grid">
        <!-- HCM KPIs -->
        <div class="nav-stat-card">
            <div class="nav-stat-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                    <circle cx="9" cy="7" r="4"></circle>
                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                    <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                </svg>
            </div>
            <div class="nav-stat-content">
                <div class="nav-stat-value" id="stat-employees">-</div>
                <div class="nav-stat-label">Employees</div>
            </div>
        </div>

        <div class="nav-stat-card">
            <div class="nav-stat-icon warning">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <polyline points="12 6 12 12 16 14"></polyline>
                </svg>
            </div>
            <div class="nav-stat-content">
                <div class="nav-stat-value" id="stat-pending">-</div>
                <div class="nav-stat-label">Pending Leave</div>
            </div>
        </div>

        <!-- Sales KPIs -->
        <div class="nav-stat-card">
            <div class="nav-stat-icon success">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="1" x2="12" y2="23"></line>
                    <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                </svg>
            </div>
            <div class="nav-stat-content">
                <div class="nav-stat-value" id="stat-sales-orders">-</div>
                <div class="nav-stat-label">Open Orders</div>
            </div>
        </div>

        <!-- CRM KPIs -->
        <div class="nav-stat-card">
            <div class="nav-stat-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                </svg>
            </div>
            <div class="nav-stat-content">
                <div class="nav-stat-value" id="stat-cases">-</div>
                <div class="nav-stat-label">Open Cases</div>
            </div>
        </div>

        <!-- Projects KPIs -->
        <div class="nav-stat-card">
            <div class="nav-stat-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
                </svg>
            </div>
            <div class="nav-stat-content">
                <div class="nav-stat-value" id="stat-projects">-</div>
                <div class="nav-stat-label">Active Projects</div>
            </div>
        </div>

        <!-- FIN KPIs -->
        <div class="nav-stat-card">
            <div class="nav-stat-icon warning">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
                    <line x1="1" y1="10" x2="23" y2="10"></line>
                </svg>
            </div>
            <div class="nav-stat-content">
                <div class="nav-stat-value" id="stat-invoices">-</div>
                <div class="nav-stat-label">Pending Invoices</div>
            </div>
        </div>

        <!-- SCM KPIs -->
        <div class="nav-stat-card">
            <div class="nav-stat-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="1" y="3" width="15" height="13"></rect>
                    <polygon points="16 8 20 8 23 11 23 16 16 16 16 8"></polygon>
                    <circle cx="5.5" cy="18.5" r="2.5"></circle>
                    <circle cx="18.5" cy="18.5" r="2.5"></circle>
                </svg>
            </div>
            <div class="nav-stat-content">
                <div class="nav-stat-value" id="stat-pos">-</div>
                <div class="nav-stat-label">Open POs</div>
            </div>
        </div>

        <!-- MFG KPIs -->
        <div class="nav-stat-card">
            <div class="nav-stat-icon success">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path>
                </svg>
            </div>
            <div class="nav-stat-content">
                <div class="nav-stat-value" id="stat-wos">-</div>
                <div class="nav-stat-label">WOs In Progress</div>
            </div>
        </div>
    </div>

    <!-- Dynamic Navigation Content -->
    <div id="nav-content"></div>
</div>

<style>
    #dashboard-section {
        /* Content area already has padding, so we just ensure no extra padding here */
    }

    #nav-stats {
        margin-bottom: var(--spacing-lg);
    }
</style>

<script>
function initMobileDashboard() {
    loadDashboardStats();
    Layer8MNav.showHome();
}

async function loadDashboardStats() {
    const kpis = [
        { id: 'stat-employees', endpoint: '/30/Employee', query: 'select * from Employee limit 1 page 0' },
        { id: 'stat-pending', endpoint: '/30/LeaveReq', query: 'select * from LeaveRequest where status=2 limit 1 page 0' },
        { id: 'stat-sales-orders', endpoint: '/60/SalesOrder', query: 'select * from SalesOrder where status=1 limit 1 page 0' },
        { id: 'stat-cases', endpoint: '/80/CrmCase', query: 'select * from CrmCase where status=1 limit 1 page 0' },
        { id: 'stat-projects', endpoint: '/90/PrjProj', query: 'select * from PrjProject where status=2 limit 1 page 0' },
        { id: 'stat-invoices', endpoint: '/40/SalesInv', query: 'select * from SalesInvoice where status=1 limit 1 page 0' },
        { id: 'stat-pos', endpoint: '/50/PurchOrder', query: 'select * from ScmPurchaseOrder where status=1 limit 1 page 0' },
        { id: 'stat-wos', endpoint: '/70/MfgWorkOrd', query: 'select * from MfgWorkOrder where status=2 limit 1 page 0' }
    ];

    // Load all KPIs in parallel
    await Promise.all(kpis.map(kpi => loadKPI(kpi)));
}

async function loadKPI(kpi) {
    try {
        const body = encodeURIComponent(JSON.stringify({ text: kpi.query }));
        const response = await Layer8MAuth.get(Layer8MConfig.resolveEndpoint(kpi.endpoint) + '?body=' + body);

        const element = document.getElementById(kpi.id);
        if (element) {
            if (response && response.metadata?.keyCount?.counts) {
                element.textContent = response.metadata.keyCount.counts.Total || 0;
            } else {
                element.textContent = '0';
            }
        }
    } catch (error) {
        console.error(`Failed to load KPI ${kpi.id}:`, error);
        const element = document.getElementById(kpi.id);
        if (element) {
            element.textContent = '0';
        }
    }
}
</script>
